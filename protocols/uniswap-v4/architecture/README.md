# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Uniswap v4

**–ê–≤—Ç–æ—Ä:** [–ü–∞–≤–µ–ª –ù–∞–π–¥–∞–Ω–æ–≤](https://github.com/PavelNaydanov) üïµÔ∏è‚Äç‚ôÇÔ∏è

**Uniswap V4** - —ç—Ç–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ DeFi –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤, —Ä–µ–∞–ª–∏–∑—É—é—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É **"Singleton Design"**, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–Ω–µ–¥—Ä—è—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É –≤ —Ä–∞–±–æ—Ç—É –ø—É–ª–∞.

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —á–µ—Ç–≤–µ—Ä—Ç–æ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –ø—Ä–µ—Ç–µ—Ä–ø–µ–ª–∞ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è: –æ–±—ä–µ–¥–∏–Ω–∏–ª–∞ –≤—Å–µ –ø—É–ª—ã –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –Ω–∞ –æ–¥–Ω–æ–º —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ –∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª–∞ –º–µ—Ö–∞–Ω–∏–∑–º "—Ö—É–∫–∏" –¥–ª—è –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏–∏ –ª–æ–≥–∏–∫–∏ –ø—É–ª–æ–≤.

–í —Ç—Ä–µ—Ç—å–µ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–æ 1 –ø—É–ª = 1 —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç. –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—É–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç —Ñ–∞–±—Ä–∏–∫–∏ [UniswapV3Factory.sol](https://github.com/Uniswap/v3-core/blob/main/contracts/UniswapV3Factory.sol), –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç [UniswapV3PoolDeployer.sol](https://github.com/Uniswap/v3-core/blob/main/contracts/UniswapV3PoolDeployer.sol).

–ü—Ä–∏ —ç—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä —Ä–∞–∑–ª–∏—á–Ω—ã–µ –≤–∏–¥—ã —Å–≤–∞–ø–∞, –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç [SwapRouter.sol](https://github.com/Uniswap/v3-periphery/blob/main/contracts/SwapRouter.sol) –Ω–∞–ø—Ä—è–º—É—é –∫ –ø—É–ª—É.

![](./images/uniswap-v3-create-pool.png)

–¢–µ–ø–µ—Ä—å —Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—É–ª–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —á–µ—Ç–≤–µ—Ä—Ç–æ–π –≤–µ—Ä—Å–∏–∏.

![](./images/uniswap-v4-create-pool.png)

–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—É–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤—ã–∑–æ–≤ [initialize()](https://github.com/Uniswap/v4-core/blob/main/src/PoolManager.sol#L117) –Ω–∞ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ [PoolManager.sol](https://github.com/Uniswap/v4-core/blob/main/src/PoolManager.sol). –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–∑–¥–∞–Ω–Ω–æ–º –ø—É–ª–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø—É–ª–æ–≤.

–ü—Ä–∏ —ç—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä —Ä–∞–∑–ª–∏—á–Ω—ã–µ –≤–∏–¥—ã —Å–≤–∞–ø–∞, –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç [V4Router.sol](https://github.com/Uniswap/v4-periphery/blob/main/src/V4Router.sol), –Ω–æ –≤—Å—è –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞ –ø—É–ª–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ [Pool.sol](https://github.com/Uniswap/v4-core/blob/main/src/libraries/Pool.sol), –∫–æ—Ç–æ—Ä—É—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `PoolManager.sol`

–°–∏–Ω–≥–ª—Ç–æ–Ω –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—É—é —ç–∫–æ–Ω–æ–º–∏—é –≥–∞–∑–∞, —Ç–∞–∫ –∫–∞–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—É–ª–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –ø—É–ª–∞. –¢–∞–∫–∂–µ –æ–±–º–µ–Ω —á–µ—Ä–µ–∑ —Ü–µ–ø–æ—á–∫—É –ø—É–ª–æ–≤ –±–æ–ª—å—à–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ —Ç–æ–∫–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –ø—É–ª—ã, —á—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —Å–Ω–∏–∂–∞–µ—Ç –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –≥–∞–∑.

## –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞

–ü—Ä–æ—Ç–æ–∫–æ–ª –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Å–ª–µ–¥–æ–≤–∞—Ç—å —Å–≤–æ–µ–π —Ç—Ä–∞–¥–∏—Ü–∏–∏ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã –Ω–∞ –¥–≤–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–∏–º –≤–µ—Ä—Å–∏—è–º:
- [v4-core](https://github.com/Uniswap/v4-core/tree/main).
- [v4-periphery](https://github.com/Uniswap/v4-periphery).

Core –≤—Å–µ —Ç–∞–∫–∂–µ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø—É–ª—ã, –∞ periphery ‚Äî –∑–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é –∫ –ø—É–ª–∞–º. –¢–∞–∫–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ç–∞–∫ –∏–ª–∏ –∏–Ω–∞—á–µ —Ä–µ–∞–ª–∏–∑—É—é—Ç –ª–æ–≥–∏–∫—É –ø—É–ª–æ–≤, —Ä–æ—É—Ç–µ—Ä–∞, LP —Ç–æ–∫–µ–Ω–∞ –∏ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏.

–°—Ö–µ–º–∞ –Ω–∏–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –≤ –¥–≤—É—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö.

![](./images/uniswap-v4-contracts-list.png)

–Ø –≤—ã–ø–∏—Å–∞–ª –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ —Ä–∞–∑–±–∏—Ç—ã—Ö –Ω–∞ 4 –≥—Ä—É–ø–ø—ã:
- **–°–∏–Ω–∏–π —Ü–≤–µ—Ç** –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª–∏–∑—É—é—Ç –ø–µ—Ä–≤–æ—Å—Ç–µ–ø–µ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É –ø—Ä–æ—Ç–æ–∫–æ–ª–∞.
- **–û—Ä–∞–Ω–∂–µ–≤—ã–π —Ü–≤–µ—Ç** –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —è–≤–ª—è—é—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏.
- **–†–æ–∑–æ–≤—ã–π —Ü–≤–µ—Ç** –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–ª–æ–∫—á–µ–π–Ω–∞.
- **–ó–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç** –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã. –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ –º—ã –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏ —Ç–æ–ª—å–∫–æ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ–ø–∏—Å—ã–≤–∞–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É —Ö—É–∫–æ–≤.

–ß–µ–º –±–æ–ª—å—à–µ —Ä–∞–∑–º–µ—Ä –Ω–∞–∑–≤–∞–Ω–∏—è —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞, —Ç–µ–º –æ–Ω –≤–∞–∂–Ω–µ–µ –≤ –∫–æ–¥–µ Uniswap. –ù–∞ —Å—Ö–µ–º–µ —Ç–∞–∫–∏—Ö —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ:
- [PoolManager.sol](https://github.com/Uniswap/v4-core/blob/main/src/PoolManager.sol). –ü–µ—Ä–≤–æ–æ—á–µ—Ä–µ–¥–Ω—ã–π —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç –∏–∑ –≥—Ä—É–ø–ø—ã core, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø—É–ª–∞–º–∏ —Ç–æ–∫–µ–Ω–æ–≤.
- [V4Router.sol](https://github.com/Uniswap/v4-periphery/blob/main/src/V4Router.sol). –°–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç –∏–∑ –≥—Ä—É–ø–ø—ã periphery, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø–µ—Ä–≤–∏—á–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥ —Ç–µ–º, –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤—ã–∑–æ–≤ –≤ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã –≥—Ä—É–ø–ø—ã core.
- [PositionManager.sol](https://github.com/Uniswap/v4-periphery/blob/main/src/PositionManager.sol). –°–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç –∏–∑ –≥—Ä—É–ø–ø—ã periphery, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é LP —Ç–æ–∫–µ–Ω–∞ (–Ω—Ñ—Ç–∏—à–∫–∏), –æ—Ç–æ–±—Ä–∞–∂–∞—é—â–µ–≥–æ –ø–æ–∑–∏—Ü–∏—é –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏. –≠—Ç–æ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª–∏—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å—é –Ω–∞ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ `PoolManager.sol`.

## –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø—É–ª–æ–≤

–°–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç [PoolManager.sol](https://github.com/Uniswap/v4-core/blob/main/src/PoolManager.sol) —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:

- **modifyLiquidity()**. –§—É–Ω–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å—é: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ –∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏. –û–±—ã—á–Ω–æ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–º –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏, –Ω–æ –Ω–µ –Ω–∞–ø—Ä—è–º—É—é, –∞ —á–µ—Ä–µ–∑ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç `PositionManager.sol`.
- **swap()**. –û–±–º–µ–Ω –∞–∫—Ç–∏–≤–æ–≤. –û–±—ã—á–Ω–æ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –Ω–æ –Ω–µ –Ω–∞–ø—Ä—è–º—É—é, –∞ —á–µ—Ä–µ–∑ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç `V4Router.sol`.
- **donate()**. –ü—Ä—è–º—ã–µ –¥–æ–Ω–∞—Ç—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏. –≠—Ç–æ —Å–ø–æ—Å–æ–± —É–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –≤ –ø—É–ª–µ –≤ –æ–±—Ö–æ–¥ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏.
- **mint()/burn()**. –ú–∏–Ω—Ç –∏ —Å–∂–∏–≥–∞–Ω–∏–µ ERC-6909, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç–∏–≤–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø—Ä–æ—Ç–æ–∫–æ–ª–µ. –ü–æ—Å–ª–µ —Å–≤–∞–ø–∞ –º–æ–∂–Ω–æ –Ω–µ –∑–∞–±–∏—Ä–∞—Ç—å —Ç–æ–∫–µ–Ω, –∞ —Å–º–∏–Ω—Ç–∏—Ç—å –µ–≥–æ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç –≤ ERC-6909. –ú–∏–Ω—Ç ERC-6909 –≤—Å–µ–≥–¥–∞ –¥–µ—à–µ–≤–ª–µ –ø–æ –≥–∞–∑—É, —á–µ–º —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä –ª—é–±–æ–≥–æ —Ç–æ–∫–µ–Ω–∞.
- **take()/settle()**. –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –ø–æ–≥–∞—à–µ–Ω–∏—è –∞–∫—Ç–∏–≤–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è flash loans –∏ –Ω–µ —Ç–æ–ª—å–∫–æ. –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤–∑—è—Ç—å –∞–∫—Ç–∏–≤—ã –∏–∑ –ø—É–ª–∞ –≤ –¥–æ–ª–≥ –∏ –ø–æ–≥–∞—Å–∏—Ç—å.
- **sync()**. –î–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—É–ª–∞ —Å –µ–≥–æ —Ç–µ–∫—É—â–∏–º–∏ —Ä–µ–∑–µ—Ä–≤–∞–º–∏ —Ç–æ–∫–µ–Ω–æ–≤ –∏ —Ü–µ–Ω–æ–π.

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ç–æ—Ä–∞–¥–∂–∞**

–ú–µ–Ω–µ–¥–∂–µ—Ä –ø—É–ª–∞ –ø—Ä–∏–æ–±—Ä–µ–ª –∫—Ä–∞—Å–∏–≤—ã–π mapping –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º –ø—É–ª–æ–≤.

```solidity
mapping(PoolId id => Pool.State) internal _pools;
```

**PoolId** - —ç—Ç–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø—É–ª–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ `bytes32`. –ü–æ —Å—É—Ç–∏, –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —è–≤–ª—è–µ—Ç—Å—è —Ö–µ—à–æ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø—É–ª–∞. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è id –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ [PoolIdLibrary](https://github.com/Uniswap/v4-core/blob/main/src/types/PoolId.sol#L9) —Å –æ–¥–Ω–æ–π –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π `toId()`.

```Solidity
// –í–∑—è—Ç–æ –∏–∑ PoolKey.sol
struct PoolKey {
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–∫–µ–Ω–µ 0
    Currency currency0;
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–∫–µ–Ω–µ 1
    Currency currency1;
    // –ö–æ–º–∏—Å—Å–∏—è
    uint24 fee;
    // –†–∞–∑–º–µ—Ä —Ç–∏–∫–∞
    int24 tickSpacing;
    // –ê–¥—Ä–µ—Å —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ —Ö—É–∫–∞
    IHooks hooks;
}

library PoolIdLibrary {
    function toId(PoolKey memory poolKey) internal pure returns (PoolId poolId) {
        assembly ("memory-safe") {
            // 0xa0 –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–∞–∑–º–µ—Ä PoolKey (5 slots of 32 bytes)
            poolId := keccak256(poolKey, 0xa0)
        }
    }
}
```

`Pool.State` - —ç—Ç–æ –≤—Å–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—É–ª–∞, –ø–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ –Ω–µ–≥–æ —á—É—Ç—å –Ω–∏–∂–µ.

–¢–∞–∫–∂–µ –≤ —Å—Ç–æ—Ä–∞–¥–∂–µ `PoolManager.sol` –¥–≤–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –æ–±–æ–∑–Ω–∞—á–∞—é—â–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≥—Ä–∞–Ω–∏—Ü—É —Ç–∏–∫–∞.

```solidity
int24 private constant MAX_TICK_SPACING = TickMath.MAX_TICK_SPACING;
int24 private constant MIN_TICK_SPACING = TickMath.MIN_TICK_SPACING;
```

–í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ç–æ—Ä–∞–¥–∂–∞ –ø–æ–ø—Ä—è—Ç–∞–Ω—ã –ø–æ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞–º –æ—Ç –∫–æ—Ç–æ—Ä—ã—Ö –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è `PoolManager.sol`.

**–û—Ç —á–µ–≥–æ –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è PoolManager**

![](./images/uniswap-v4-pool-manager.png)

- [NoDelegateCall.sol](https://github.com/Uniswap/v4-core/blob/main/src/NoDelegateCall.sol). –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞. –ó–∞—â–∏—â–∞–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏. –ö–æ–≥–¥–∞ –¥–µ–ª–∞–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω—ã–π –≤—ã–∑–æ–≤, —Ç–æ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è –∏—Å–ø–æ–ª–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –¥—Ä—É–≥–æ–≥–æ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞. –î—Ä—É–≥–∏–º–∏ —Å–ª–æ–≤–∞–º–∏, `delegateCall` –∫ `PoolManager` –∑–∞–ø—Ä–µ—â–µ–Ω –≤ —Ü–µ–ª—è—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
- [ERC6909Claims.sol](https://github.com/Uniswap/v4-core/blob/main/src/ERC6909Claims.sol). –ü–æ–∑–≤–æ–ª—è–µ—Ç –º–∏–Ω—Ç–∏—Ç—å –∏ —Å–∂–∏–≥–∞—Ç—å —Ç–æ–∫–µ–Ω –≤ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç –∞–∫—Ç–∏–≤–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞.
- [Extsload.sol](https://github.com/Uniswap/v4-core/blob/main/src/Extsload.sol) –∏ [Exttload.sol](https://github.com/Uniswap/v4-core/blob/main/src/Exttload.sol). –ü–æ–∑–≤–æ–ª—è–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–µ [TransientStateLibrary.sol](https://github.com/Uniswap/v4-core/blob/main/src/libraries/TransientStateLibrary.sol) —á–∏—Ç–∞—Ç—å –∏ –ø–∏—Å–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ. –°–∞–º–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–∑-–∑–∞ –ø—Ä–µ–¥–µ–ª–æ–≤ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –≥—Ä—É–ø–ø—ã core. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π.

–ù–æ —ç—Ç–æ –µ—â–µ –Ω–µ –≤—Å–µ, –µ—Å–ª–∏ –≤—Å–ø–æ–º–Ω–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç —Å–æ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞–º–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤, —Ç–æ —Ç–∞–º –±—ã–ª–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–æ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ª–æ–≥–∏–∫–∏, –≤—ã–Ω–µ—Å–µ–Ω–Ω–æ–π –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.

![](./images/uniswap-v4-pool-manager-and-libraries.png)

–ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –±–∏–±–ª–∏–æ—Ç–µ–∫ —Å–∏–ª—å–Ω–æ [–±–æ–ª—å—à–µ](https://github.com/Uniswap/v4-core/tree/main/src/libraries). –ù–æ –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç [Pool.sol](https://github.com/Uniswap/v4-core/blob/main/src/libraries/Pool.sol). –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫ –ø—É–ª—É: –æ—Ç –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏, –¥–æ —Å–≤–∞–ø–∞ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–∏–∫–µ.

–í `Pool.sol` –æ–ø–∏—Å–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ [—Å–æ—Å—Ç–æ—è–Ω–∏—è](https://github.com/Uniswap/v4-core/blob/main/src/libraries/Pool.sol#L83C1-L91C6) –ø—É–ª–∞. –ú—ã –æ–±–µ—â–∞–ª–∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∞–Ω–µ–µ.

```solidity
struct State {
    Slot0 slot0; // –£–ø–∞–∫–æ–≤–∞–Ω–Ω—ã–µ –±–∞–π—Ç—ã: —Å—Ç–æ–∏–º–æ—Å—Ç—å, –∫–æ–º–∏—Å—Å–∏—è, —Ñ–ª–∞–≥ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, —Ç–µ–∫—É—â–∏–π —Ç–∏–∫
    uint256 feeGrowthGlobal0X128; // –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏ –¥–ª—è –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –ø–æ —Ç–æ–∫–µ–Ω—É 0
    uint256 feeGrowthGlobal1X128; // –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏ –¥–ª—è –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –ø–æ —Ç–æ–∫–µ–Ω—É 1
    uint128 liquidity; // –û–±—â–∞—è —Ç–µ–∫—É—â–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –ø—É–ª–∞, –≤—ã—Ä–∞–∂–µ–Ω–Ω–∞—è –≤ –µ–¥–∏–Ω–∏—Ü–∞—Ö –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏
    mapping(int24 tick => TickInfo) ticks; // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –≤–æ –≤—Å–µ—Ö —Ç–∏–∫–∞—Ö
    mapping(int16 wordPos => uint256) tickBitmap; // –ë–∏—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–∫–æ–≤ –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ —Å–≤–æ–ø–∞—Ö
    mapping(bytes32 positionKey => Position.State) positions; // –•—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –≤ –ø—É–ª–µ
}
```

–£–∂–µ –ø–æ—Ç–æ–º —Å–ª–µ–¥—É–µ—Ç –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏:
- [StateLibrary.sol](https://github.com/Uniswap/v4-core/blob/main/src/libraries/StateLibrary.sol). –ü–æ–º–æ–≥–∞–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ Slot0. –ù–∞–ø—Ä—è–º—É—é –≤ `PositionManager.sol` –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ —Ö–æ—Ä–æ—à–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É Slot0.
- [Position.sol](https://github.com/Uniswap/v4-core/blob/main/src/libraries/Position.sol). –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–æ–∑–∏—Ü–∏–µ–π –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏.
- [TickBitmap.sol](https://github.com/Uniswap/v4-core/blob/main/src/libraries/TickBitmap.sol) –∏ [TickMath.sol](https://github.com/Uniswap/v4-core/blob/main/src/libraries/TickMath.sol). –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∏–∫–∞–º–∏.
- [SwapMath.sol](https://github.com/Uniswap/v4-core/blob/main/src/libraries/SwapMath.sol). –ü–æ–º–æ–≥–∞–µ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–≤–æ–ø–∞.
- [Hooks.sol](https://github.com/Uniswap/v4-core/blob/main/src/libraries/Hooks.sol). –í—ã–ø–æ–ª–Ω—è–µ—Ç –ª–æ–≥–∏–∫—É —Ö—É–∫–æ–≤: –≤–∞–ª–∏–¥–∞—Ü–∏—é –∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ.

–≠—Ç–æ –±—ã–ª–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è, –¥–∞–ª—å—à–µ –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –∫–æ–¥–æ–º –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

## –§–ª–æ—É –≤—ã–∑–æ–≤–∞ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤

–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ —Ä–∞–∑–±–µ—Ä–µ–º —Ñ–ª–æ—É –≤—ã–∑–æ–≤–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ—Ç –º–æ–º–µ–Ω—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –¥–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ö. –£—Å–ª–æ–≤–Ω–æ –º–æ–∂–Ω–æ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –¥–≤–∞ —Ç–∏–ø–∞:
- –ü–æ—Å—Ç–∞–≤—â–∏–∫ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π –∞–∫—Ç–∏–≤—ã –≤ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –ø—É–ª —Ç–æ–∫–µ–Ω–æ–≤.
- –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –≤—ã–ø–æ–ª–Ω—è—é—â–∏–π —Å–≤–∞–ø –æ–¥–Ω–æ–≥–æ –∞–∫—Ç–∏–≤–∞ –Ω–∞ –¥—Ä—É–≥–æ–π.

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±—É–¥–µ—Ç —Ä–∞–∑–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞.

![](./images/uniswap-v4-user-flow.png)

–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å–æ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–º [PositionManager.sol](https://github.com/Uniswap/v4-periphery/blob/main/src/PositionManager.sol#L195), –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–∑–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø—É–ª–æ–≤.

–û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç [V4Router.sol](https://github.com/Uniswap/v4-periphery/blob/main/src/V4Router.sol#L32), –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–∑–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø—É–ª–æ–≤.

–û–±–µ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞, —á—Ç–æ –ª–æ–≥–∏—á–Ω–æ, –Ω–∞—Å–ª–µ–¥—É—é—Ç—Å—è –æ—Ç —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ [BaseActionsRouter.sol](https://github.com/Uniswap/v4-periphery/blob/main/src/base/BaseActionsRouter.sol), –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—Ö–æ–¥—è—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.

## –ö—Ä–æ—Å—Å-–≤–µ—Ä—Å–∏–æ–Ω–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è

–ù—É–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å, —á—Ç–æ –Ω–∞ –º–æ–º–µ–Ω—Ç –Ω–∞–ø–∏—Å–∞–Ω–∏—è —Å—Ç–∞—Ç—å–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤—Ç–æ—Ä–∞—è, —Ç—Ä–µ—Ç—å—è –∏ —á–µ—Ç–≤–µ—Ä—Ç–∞—è –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞. –ò —è –¥—É–º–∞—é —ç—Ç–æ –Ω–µ –ø—Ä–µ–¥–µ–ª! –°–≤–∞–ø—ã –º–æ–≥—É—Ç –≤—ã—Å—Ç—Ä–∞–∏–≤–∞—Ç—å—Å—è –≤ —Ü–µ–ª—É—é —Ü–µ–ø–æ—á–∫—É –æ–±–º–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ —Ä–∞–∑–Ω—ã–µ –ø—É–ª—ã –∏ —Ä–∞–∑–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞.

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –ª–æ–≥–∏—á–Ω–æ –ø–æ—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Å–ª–æ–π–∫–∏ –º–µ–∂–¥—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –∏ —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤. –¢–∞–∫–∞—è –ø—Ä–æ—Å–ª–æ–π–∫–∞ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è **UniversalRouter** –∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º [—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏](https://github.com/Uniswap/universal-router).

![](./images/uniswap-v4-universal-router.png)

–°–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç [UniversalRouter.sol](https://github.com/Uniswap/universal-router/blob/main/contracts/UniversalRouter.sol) –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ (—Ä–æ—É—Ç–µ—Ä–æ–≤), –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É —Å –∫–∞–∂–¥–æ–π –∏–∑ –≤–µ—Ä—Å–∏–π –ø—Ä–æ—Ç–æ–∫–æ–ª–∞.

![](./images/uniswap-v4-universal-router-inherit.png)

–î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `UniversalRouter.sol` –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–∑–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é [execute(bytes calldata commands, bytes[] calldata inputs, uint256 deadline)](https://github.com/Uniswap/universal-router/blob/main/contracts/UniversalRouter.sol#L35). –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–∞–±–æ—Ä –±–∞–π—Ç –∫–æ–º–∞–Ω–¥ (–∏–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω–∞–ø—Ä–∏–º–µ—Ä —Å–≤–∞–ø –≤ UniV2), –º–∞—Å—Å–∏–≤ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–∞–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è, —Å—É–º–º–∞ –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã) –∏ –¥–µ–¥–ª–∞–π–Ω.

–ù–∏–∂–µ –ø—Å–µ–≤–¥–æ–∫–æ–¥: –∫–∞–∫ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –≤—ã–∑–æ–≤ execute().

```solidity
import {Commands} from 'universal-router/contracts/libraries/Commands.sol';

...

function executeV2SwapExactOut(address recipient, uint256 amountIn, uint256 amountOutMin) external {
    uint256 deadline = block.timestamp + 60;
    bytes memory commands = abi.encodePacked(bytes1(uint8(Commands.V2_SWAP_EXACT_OUT)));

    bytes[] memory inputs = new bytes[](1);
    inputs[0] = abi.encode(
      recipient,
      amountIn,
      amountOutMin,
      abi.encodePacked(WETH, DAI),
      true // –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫—Ç–æ –æ–ø–ª–∞—Ç–∏—Ç –≤—ã–∑–æ–≤
    );

    IUniversalRouter(router).execute{value: 0}(commands, inputs, deadline);
}
```

–ù–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–º–∞–Ω–¥ –∫–æ–¥–∏—Ä—É–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

```solidity
bytes memory commands = abi.encodePacked(
    bytes1(uint8(Commands.V2_SWAP_EXACT_OUT)),
    bytes1(uint8(Commands.V4_POSITION_MANAGER_CALL))
);
```

_–í–∞–∂–Ω–æ!_ –°—Ç–æ–∏—Ç –æ—Ü–µ–Ω–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤. –í —Ü–µ–ø–æ—á–∫–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç [V4SwapRouter.sol](https://github.com/Uniswap/universal-router/blob/main/contracts/modules/uniswap/v4/V4SwapRouter.sol#L11) –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ [V4Router.sol](https://github.com/Uniswap/v4-periphery/blob/main/src/V4Router.sol), –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ periphery.

## –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –ø—Ä–∏–µ–º—ã –≤ –∫–æ–¥–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞

–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ —Ä–∞–∑–±–µ—Ä–µ–º –µ—â–µ –±–æ–ª—å—à–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –≤ –ø—Ä–æ—Ç–æ–∫–æ–ª–µ.

### –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—É–ª–∞

–ü–æ –¥–µ—Ñ–æ–ª—Ç—É –ø—É–ª—ã —Ç–æ–∫–µ–Ω–æ–≤ "–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã", —Ç–æ –µ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –Ω–∏–º–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—É–ª–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ, –∏ –Ω–∏–∫—Ç–æ –Ω–µ –º–æ–∂–µ—Ç –≤–º–µ—à–∞—Ç—å—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å. –ü–æ —Å—É—Ç–∏ —ç—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ (reentrancy).

–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø—É–ª–∞ —Ñ—É–Ω–∫—Ü–∏—è [unlock()](https://github.com/Uniswap/v4-core/blob/main/src/PoolManager.sol#L104). –ü–æ —Å–æ–≤–º–µ—Å—Ç–∏—Ç–µ–ª—å—Å—Ç–≤—É, —Ñ—É–Ω–∫—Ü–∏—è `unlock()` —è–≤–ª—è–µ—Ç—Å—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π —Ç–æ—á–∫–æ–π –≤—Ö–æ–¥–∞ –¥–ª—è —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ `PoolManager.sol`.

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ –ø–æ–º–æ—â–∏ [EIP-1153: Transient storage opcodes](https://eips.ethereum.org/EIPS/eip-1153).

> –ú—ã –ø–∏—Å–∞–ª–∏ –ø—Ä–æ Transient Storage. –ï—Å–ª–∏ —Ö–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å –ø—Ä–æ –Ω–µ–≥–æ –±–æ–ª—å—à–µ, —Ç–æ –∏—â–∏ –µ–≥–æ –≤–Ω—É—Ç—Ä–∏ –Ω–∞—à–µ–≥–æ wiki –≤ –ø–∞–ø–∫–µ EIPs.

–í–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—É–ª–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ —Å—Ö–µ–º–µ –Ω–∏–∂–µ.

![](./images/uniswap-v4-lock-pool.png)

–õ—é–±–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ø–∞–≤—à–µ–µ –Ω–∞ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç —Ä–æ—É—Ç–∏–Ω–≥–∞ (`V4Router.sol`, `PositionManager.sol`) –ø–µ—Ä–≤—ã–º –¥–µ–ª–æ–º –≤—ã–∑—ã–≤–∞–µ—Ç [unlock()](https://github.com/Uniswap/v4-periphery/blob/main/src/base/BaseActionsRouter.sol#L26) –Ω–∞ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ [PoolManager.sol](https://github.com/Uniswap/v4-core/blob/main/src/PoolManager.sol#L104).

–ü–æ—Å–ª–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ `PoolManager.sol` –¥–µ–ª–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω—ã–π –≤—ã–∑–æ–≤ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é [unlockCallback()](https://github.com/Uniswap/v4-core/blob/main/src/PoolManager.sol#L110). –ó–∞—Ç–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è [–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è](https://github.com/Uniswap/v4-periphery/blob/main/src/base/BaseActionsRouter.sol#L51) –∏ —Å–Ω–æ–≤–∞ –¥–µ–ª–∞–µ—Ç—Å—è –≤—ã–∑–æ–≤ –Ω–∞ `PoolManager.sol` —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å—é –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–í –∫–æ–Ω—Ü–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—É–ª –±—É–¥–µ—Ç —Å–Ω–æ–≤–∞ [–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω](https://github.com/Uniswap/v4-core/blob/main/src/PoolManager.sol#L113) –∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–∏. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –∫—Ç–æ –ø—É–ª —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª, —Ç–æ—Ç –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é.

```solidity
function unlock(bytes calldata data) external override returns (bytes memory result) {
    if (Lock.isUnlocked()) AlreadyUnlocked.selector.revertWith();

    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø—É–ª, –µ—Å–ª–∏ –æ–Ω –Ω–µ –±—ã–ª —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
    Lock.unlock();

    // –î–µ–ª–∞–µ–º –æ–±—Ä–∞—Ç–Ω—ã–π –≤—ã–∑–æ–≤ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
    result = IUnlockCallback(msg.sender).unlockCallback(data);

    ...

    // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—É–ª
    Lock.lock();
}
```

–§—É–Ω–∫—Ü–∏—è [unlockCallback()](https://github.com/Uniswap/v4-periphery/blob/main/src/base/SafeCallback.sol) –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ [SafeCallback.sol](https://github.com/Uniswap/v4-periphery/blob/main/src/base/SafeCallback.sol), –æ—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è [BaseActionsRouter.sol](https://github.com/Uniswap/v4-periphery/blob/main/src/base/BaseActionsRouter.sol#L12C19-L12C36).

–°–∞–º–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ [BaseActionsRouter.sol](https://github.com/Uniswap/v4-periphery/blob/main/src/base/BaseActionsRouter.sol#L32).

```solidity
function _unlockCallback(bytes calldata data) internal override returns (bytes memory) {
    // –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã–∑–æ–≤–∞
    (bytes calldata actions, bytes[] calldata params) = data.decodeActionsRouterParams();

    // –í—ã–ø–æ–ª–Ω—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é/–æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    _executeActionsWithoutUnlock(actions, params);

    return "";
}
```

–ó–¥–µ—Å—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å, —á—Ç–æ –∏–∑ —Å–µ–±—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–∞–º–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (Transient Storage).

–ó–¥–µ—Å—å –≤—Å–µ –ø—Ä–æ—Å—Ç–æ, –Ω–∞–ø–∏—Å–∞–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ [Lock.sol](https://github.com/Uniswap/v4-core/blob/main/src/libraries/Lock.sol) —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä—É—é –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Ñ–ª–∞–≥ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ –ø–æ–º–æ—â–∏ –Ω–æ–≤—ã—Ö –æ–ø–∫–æ–¥–æ–≤ `tstore`, `tload`.

```solidity
library Lock {
    // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ö–µ—à —Å–ª–æ—Ç–∞
    bytes32 internal constant IS_UNLOCKED_SLOT = ...;

    function unlock() internal {
        assembly ("memory-safe") {
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ
            tstore(IS_UNLOCKED_SLOT, true)
        }
    }

    function lock() internal {
        assembly ("memory-safe") {
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ
            tstore(IS_UNLOCKED_SLOT, false)
        }
    }

    ...
}
```

–¢–∞–∫–∏–º –Ω–µ–∑–∞–º—ã—Å–ª–æ–≤–∞—Ç—ã–º –æ–±—Ä–∞–∑–æ–º –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –≤—ã–∑–æ–≤–∞. –í –±—É–¥—É—â–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å —É–ø—Ä–∞–∑–¥–Ω–µ–Ω–∞, –∫–æ–≥–¥–∞ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä Solidity –≤–≤–µ–¥–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º.

### –ö–∞–∫ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã —Ö—É–∫–∏

–¢–µ–æ—Ä–∏—è –ø—Ä–æ—Å—Ç–∞. –ì–æ—Ç–æ–≤–∏—Ç–µ –≤–∞—à —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç —Ö—É–∫–∞ (–¥–ª—è —ç—Ç–æ–≥–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞–¥–æ –Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å –µ–≥–æ –æ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ–≥–æ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ [BaseHook.sol](https://github.com/Uniswap/v4-periphery/blob/main/src/utils/BaseHook.sol)) –∏ —Å–æ–∑–¥–∞–µ—Ç–µ –ø—É–ª —Å —ç—Ç–∏–º —Ö—É–∫–æ–º. –¢–µ–ø–µ—Ä—å –≤—Å–µ –≤—ã–∑–æ–≤—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±—É–¥—É—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ —ç—Ç–æ—Ç —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç —Ö—É–∫–∞.

–î–ª—è —ç—Ç–æ–π –º–µ—Ö–∞–Ω–∏–∫–∏ —Ö—É–∫–æ–≤ –ª–æ–≥–∏—á–Ω–æ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç—å, —á—Ç–æ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø—É–ª–æ–≤ –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å –¥–≤–µ –≤–µ—â–∏:
1. –ó–Ω–∞—Ç—å —Ö—É–∫ –∫–∞–∂–¥–æ–≥–æ –ø—É–ª–∞ (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å)
2. –£–º–µ—Ç—å –¥–µ–ª–∞—Ç—å –≤—ã–∑–æ–≤—ã –Ω–∞ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç —Ö—É–∫–∞

–í—Å–µ —Ö—É–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ –æ–¥–Ω–æ–º—É –ø—Ä–∏–Ω—Ü–∏–ø—É, –ø–æ—ç—Ç–æ–º—É —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º —Ñ—É–Ω–∫—Ü–∏—é [swap()](https://github.com/Uniswap/v4-core/blob/main/src/PoolManager.sol#L187) –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø—Ä–∏–º–µ—Ä–∞.

![](./images/uniswap-v4-hook-flow.png)

–í –∫–æ–¥–µ –∑–∞–ø—É—Å–∫ —Ö—É–∫–∞ –¥–æ –∏ –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–æ—Å—Ç–æ –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ `beforeSwap()`/`afterSwap()`.

```solidity
function swap(PoolKey memory key, SwapParams memory params, bytes calldata hookData)
    external
    onlyWhenUnlocked
    noDelegateCall
    returns (BalanceDelta swapDelta)
{
    ...

    BeforeSwapDelta beforeSwapDelta;
    {
        int256 amountToSwap;
        uint24 lpFeeOverride;
        (amountToSwap, beforeSwapDelta, lpFeeOverride) =

        // –í—ã–∑–æ–≤ —Ö—É–∫–∞ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º —Å–≤–æ–ø–∞
        key.hooks.beforeSwap(key, params, hookData);

        swapDelta = _swap(...);
    }

    BalanceDelta hookDelta;
    // –í—ã–∑–æ–≤ —Ö—É–∫–∞ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ö—É–∫–∞
    (swapDelta, hookDelta) = key.hooks.afterSwap(key, params, swapDelta, hookData, beforeSwapDelta);

    ...
}
```

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, —Ö—É–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–æ –∏ –ø–æ—Å–ª–µ –ª—é–±–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –•—Ä–∞–Ω–∏—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–¥—Ä–µ—Å–µ —Ö—É–∫–∞ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ [PoolKey](https://github.com/Uniswap/v4-core/blob/main/src/types/PoolKey.sol#L21).

_–í–∞–∂–Ω–æ!_ –°—Ç–æ–∏—Ç –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä —Ñ—É–Ω–∫—Ü–∏–∏ `swap()` –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º `bytes calldata hookData`. –≠—Ç–æ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –±–∞–π—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–¥–∞–Ω –≤–º–µ—Å—Ç–µ —Å –≤—ã–∑–æ–≤–æ–º –≤ —Ö—É–∫.

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã —Ö—É–∫–æ–≤**

–ï—Å–ª–∏ —Å —Ñ–ª–æ—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ö—É–∫–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤—Å–µ –ø–æ–Ω—è—Ç–Ω–æ, —Ç–æ —Å–æ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞–º–∏ –Ω–µ–º–Ω–æ–∂–∫–æ —Å–ª–æ–∂–Ω–µ–µ.

![](./images/uniswap-v4-hook-architecture.png)

–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ, –ø—Ä–∏ –≤—ã–∑–æ–≤–µ —Å–≤–æ–ø–∞, —Ñ—É–Ω–∫—Ü–∏—è –Ω–∞ `PoolManager.sol` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä `PoolKey`, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–∏–º–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–∫–µ–Ω–∞—Ö —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–¥—Ä–µ—Å–µ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ —Ö—É–∫–æ–≤.

_–í–∞–∂–Ω–æ!_ –ê–¥—Ä–µ—Å —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ —Ö—É–∫–æ–≤ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —É—á–∞—Å—Ç–∏–µ –≤ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –ø—É–ª–∞. –ò–º–µ–Ω–Ω–æ –ø–æ—ç—Ç–æ–º—É —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç —Ö—É–∫–æ–≤ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –µ–¥–∏–Ω–æ–∂–¥—ã –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—É–ª–∞.

–ó–∞—Ç–µ–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–∑–æ–≤—ã —Ö—É–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞–∫–∏–¥—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –≤—Å–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã `IHooks`. –ò–º–µ–Ω–Ω–æ —ç—Ç–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –≤—ã–∑–æ–≤ –∏ –µ—Å–ª–∏ —Ö—É–∫ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω, —Ç–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –≤—ã–∑–æ–≤ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç `CustomHook.sol`, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç –±–∞–∑–æ–≤–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ `BaseHook.sol`.

**–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ö—É–∫–æ–≤**

–õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–∑–æ–≤–∞ —Ö—É–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ [Hooks.sol](https://github.com/Uniswap/v4-core/blob/main/src/libraries/Hooks.sol).

–ï—Å–ª–∏ —Ö—É–∫ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, —Ç–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑–æ–≤ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –Ω–æ –∫–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫—É —Ç—Ä–∞—Ç–∏—Ç—å—Å—è –≥–∞–∑, –±–µ–∑ —ç—Ç–æ–≥–æ –Ω–∏–∫—É–¥–∞.

```solidity
function beforeSwap(IHooks self, PoolKey memory key, SwapParams memory params, bytes calldata hookData)
    internal
    returns (int256 amountToSwap, BeforeSwapDelta hookReturn, uint24 lpFeeOverride)
{
    ...

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Ö—É–∫ –∞–∫—Ç–∏–≤–µ–Ω
    if (self.hasPermission(BEFORE_SWAP_FLAG)) {
        // –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ beforeSwap –Ω–∞ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ —Ö—É–∫–∞
        bytes memory result = callHook(self, abi.encodeCall(IHooks.beforeSwap, (msg.sender, key, params, hookData)));

        ...
    }
}
```

**–•—É–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏**

–ï—Å—Ç—å –æ–¥–Ω–æ –≤–∞–∂–Ω–æ–µ –æ—Ç–ª–∏—á–∏–µ –≤ —Ö—É–∫–µ, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏. –ú—ã –∑–Ω–∞–µ–º, —á—Ç–æ –∞–¥—Ä–µ—Å —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ —Ö—É–∫–∞ –Ω–µ —Å–ª—É—á–∞–π–Ω—ã–π, –æ–Ω —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–º–æ—â–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ [HookMiner.sol](https://github.com/Uniswap/v4-periphery/blob/main/src/utils/HookMiner.sol), –∫–æ—Ç–æ—Ä–∞—è –≤ –∞–¥—Ä–µ—Å —Ö—É–∫–∞ –∑–∞—à–∏–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ñ—É–Ω–∫—Ü–∏–π (–¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–≤–∞–ø –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ) –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö —Ö—É–∫ –∞–∫—Ç–∏–≤–µ–Ω.

–ü–æ—ç—Ç–æ–º—É –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—É–ª–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∞–¥—Ä–µ—Å —Ö—É–∫–∞.

```solidity
function initialize(PoolKey memory key, uint160 sqrtPriceX96) external noDelegateCall returns (int24 tick) {
    ...

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥—Ä–µ—Å–∞ —Ö—É–∫–∞
    if (!key.hooks.isValidHookAddress(key.fee)) Hooks.HookAddressNotValid.selector.revertWith(address(key.hooks));

    ...

    // –í—ã–∑–æ–≤ —Ö—É–∫–∞ –¥–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—É–ª–∞
    key.hooks.beforeInitialize(key, sqrtPriceX96);

    PoolId id = key.toId();
    tick = _pools[id].initialize(sqrtPriceX96, lpFee);

    ...

    // –í—ã–∑–æ–≤ —Ö—É–∫–∞ –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—É–ª–∞
    key.hooks.afterInitialize(key, sqrtPriceX96, tick);
}
```

## –í—ã–≤–æ–¥

Uniswap V4 –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∑–∞–¥–∞–≤–∞—Ç—å —Ç—Ä–µ–Ω–¥—ã –≤ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ DeFi –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –ø—É–ª–æ–≤ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –≤ –æ–¥–∏–Ω —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–µ —Ç–æ–ª—å–∫–æ —Å–Ω–∏–∂–∞–µ—Ç –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –≥–∞–∑ –∑–∞ —Å—á—ë—Ç —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã, –Ω–æ –∏ —É–ø—Ä–æ—â–∞–µ—Ç "—Å–ª–æ–∂–Ω—ã–µ" —Å–≤–æ–ø—ã, —É—Å—Ç—Ä–∞–Ω—è—è —Ñ–∏–∑–∏—á–µ—Å–∫—É—é –ø–µ—Ä–µ–¥–∞—á—É —Ç–æ–∫–µ–Ω–æ–≤ –º–µ–∂–¥—É –ø—É–ª–∞–º–∏.

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ V4, —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ `PoolManager.sol`, –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π –±–ª–∞–≥–æ–¥–∞—Ä—è –º–µ—Ö–∞–Ω–∏–∑–º—É —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É—è EIP-1153), –∑–∞—â–∏—â–∞—è –æ—Ç reentrancy –∞—Ç–∞–∫.

–ù–æ–≤–∞—è —Ñ–∏—á–∞ "—Ö—É–∫–∏" –¥–æ–±–∞–≤–ª—è–µ—Ç –≥–∏–±–∫–æ—Å—Ç—å, –ø–æ–∑–≤–æ–ª—è—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º –≤–Ω–µ–¥—Ä—è—Ç—å –∫–∞—Å—Ç–æ–º–Ω—É—é –ª–æ–≥–∏–∫—É.

Uniswap V4 ‚Äî —ç—Ç–æ –Ω–µ —Ç–æ–ª—å–∫–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, –Ω–æ –∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –∏–Ω–Ω–æ–≤–∞—Ü–∏–π –≤ DeFi, –æ–∂–∏–¥–∞—é—â–∞—è –≤–∞—à–µ–≥–æ –≤–∫–ª–∞–¥–∞!

–ë–ª–∞–≥–æ–¥–∞—Ä—è —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ –º—ã —Ä–∞–∑–æ–±—Ä–∞–ª–∏ –æ—Å–Ω–æ–≤—ã V4, –æ—Å—Ç–∞–≤–∏–≤ –ø—Ä–æ—Å—Ç–æ—Ä –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è ‚Äî –æ—Ç –≥–ª—É–±–æ–∫–æ–≥–æ –ø–æ–≥—Ä—É–∂–µ–Ω–∏—è –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏, —Ç–∞–∫–∏–µ –∫–∞–∫ `Pool.sol`, `SwapMath.sol` –∏ `Hooks.sol`, –¥–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ —Å —Ö—É–∫–∞–º–∏.